#!/usr/bin/env -S java --source 25

/**
 * znotes - adds a thought to a notes file
 *          stored in a folder configured via zcfg convention:
 *          1. ~/.znotes/app.properties (global)
 *          2. ./app.properties (local, overwrites global)
 *          3. -D system properties (highest priority)
 *
 *          property: notes.folder (default: ~/znotes)
 *
 * Usage: znotes <thought>
 *        znotes -l           (list all thoughts)
 *        znotes -o           (open notes file with default application)
 */

import java.nio.file.Files;
import java.nio.file.Path;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Properties;

String version = "2026-02-18.1";
String APP_NAME = "znotes";
String NOTES_FILE = "thoughts.md";

enum Log {

    ERROR(Color.BRIGHT_RED, System.err),
    INFO(Color.BRIGHT_GREEN, System.out),
    USER(Color.BRIGHT_WHITE, System.out),
    SYSTEM(Color.SKY_BLUE, System.out);

    PrintStream out;

    enum Color {
        BRIGHT_RED("\033[38;5;196m"),
        BRIGHT_GREEN("\033[38;5;46m"),
        BRIGHT_WHITE("\033[38;5;255m"),
        SKY_BLUE("\033[38;5;39m");

        String code;

        Color(String code) {
            this.code = code;
        }
    }

    private final String value;
    private final static String RESET = "\u001B[0m";

    private Log(Color color, PrintStream out) {
        this.value = (color.code + "%s" + RESET);
        this.out = out;
    }

    public void out(String message) {
        this.out.println(this.value.formatted(message));
    }

    public static void error(String message) {
        Log.ERROR.out(message);
    }

    public static void info(String message) {
        Log.INFO.out(message);
    }

    public static void user(String message) {
        Log.USER.out(message);
    }

    public static void system(String message) {
        Log.SYSTEM.out(message);
    }

    public static void stop(String message) {
        error(message);
        System.exit(1);
    }
}

Properties loadConfig() {
    var properties = new Properties();
    var userHome = System.getProperty("user.home");
    var globalConfig = Path.of(userHome, "." + APP_NAME, "app.properties");
    if (Files.exists(globalConfig)) {
        loadFromFile(globalConfig, properties);
    }
    var localConfig = Path.of("app.properties");
    if (Files.exists(localConfig)) {
        loadFromFile(localConfig, properties);
    }
    properties.putAll(System.getProperties());
    return properties;
}

void loadFromFile(Path file, Properties properties) {
    try (var reader = Files.newBufferedReader(file)) {
        properties.load(reader);
    } catch (Exception e) {
        Log.stop("Cannot load config from: " + file + " - " + e.getMessage());
    }
}

Path notesFolder(Properties config) {
    var userHome = System.getProperty("user.home");
    var defaultFolder = Path.of(userHome, APP_NAME).toString();
    return Path.of(config.getProperty("notes.folder", defaultFolder));
}

void addThought(Path folder, String thought) {
    try {
        Files.createDirectories(folder);
        var file = folder.resolve(NOTES_FILE);
        var timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"));
        var entry = "- **%s** %s%n".formatted(timestamp, thought);
        Files.writeString(file, entry, java.nio.file.StandardOpenOption.CREATE, java.nio.file.StandardOpenOption.APPEND);
        Log.info("znotes v" + version + " - thought added to " + file);
    } catch (Exception e) {
        Log.stop("Failed to write thought: " + e.getMessage());
    }
}

void listThoughts(Path folder) {
    var file = folder.resolve(NOTES_FILE);
    if (!Files.exists(file)) {
        Log.info("No thoughts yet in " + file);
        return;
    }
    try {
        var content = Files.readString(file);
        Log.system("znotes v" + version + " - " + file);
        Log.user(content);
    } catch (Exception e) {
        Log.stop("Failed to read thoughts: " + e.getMessage());
    }
}

void openNotes(Path folder) {
    var file = folder.resolve(NOTES_FILE);
    if (!Files.exists(file)) {
        Log.info("No thoughts yet in " + file);
        return;
    }
    try {
        new ProcessBuilder("open", file.toString()).start();
        Log.info("znotes v" + version + " - opening " + file);
    } catch (Exception e) {
        Log.stop("Failed to open notes: " + e.getMessage());
    }
}

void main(String... args) {
    if (args.length == 0) {
        Log.info("Usage: znotes <thought>  - add a thought");
        Log.info("       znotes -l         - list all thoughts");
        Log.info("       znotes -o         - open notes file");
        return;
    }

    var config = loadConfig();
    var folder = notesFolder(config);

    if ("-l".equals(args[0])) {
        listThoughts(folder);
        return;
    }

    if ("-o".equals(args[0])) {
        openNotes(folder);
        return;
    }

    var thought = String.join(" ", args);
    addThought(folder, thought);
}
