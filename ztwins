#!/usr/bin/env -S java --source 25

/**
 * ztwins - Find files with identical content
 *
 * Logging is based on https://github.com/AdamBien/zcl
 *
 * Usage: ./ztwins <file> <directory>
 */

enum Log {

    ERROR(Color.BRIGHT_RED, System.err),
    USER(Color.BRIGHT_WHITE, System.out),
    INFO(Color.BRIGHT_GREEN, System.out),
    SYSTEM(Color.SKY_BLUE, System.out),
    WARNING(Color.WARM_YELLOW, System.out),
    DEBUG(Color.SOFT_PURPLE, System.out);

    PrintStream out;

    enum Color {
        BRIGHT_WHITE("\033[38;5;255m"),
        BRIGHT_RED("\033[38;5;196m"),
        BRIGHT_GREEN("\033[38;5;46m"),
        WARM_YELLOW("\033[38;5;220m"),
        SKY_BLUE("\033[38;5;39m"),
        SOFT_PURPLE("\033[38;5;129m");

        String code;

        Color(String code) {
            this.code = code;
        }
    }

    private final String value;
    private final static String RESET = "\u001B[0m";

    private Log(Color color, PrintStream out) {
        this.value = (color.code + "%s" + RESET);
        this.out = out;
    }

    public void out(String message) {
        this.out.println(this.value.formatted(message));
    }

    public static void info(String message) { Log.INFO.out(message); }
    public static void error(String message) { Log.ERROR.out(message); }
    public static void user(String message) { Log.USER.out(message); }

    public static void stop(String message) {
        error(message);
        System.exit(1);
    }
}

String version = "2026-02-12.1";

void main(String... args) throws Exception {
    Log.info("ztwins " + version);
    if (args.length < 2)
        Log.stop("Usage: ztwins <file> <directory>");
    var file = Path.of(args[0]);
    var directory = Path.of(args[1]);
    if (!Files.isRegularFile(file))
        Log.stop("Not a file: " + file);
    if (!Files.isDirectory(directory))
        Log.stop("Not a directory: " + directory);
    var reference = Files.readAllBytes(file);
    try (var entries = Files.walk(directory)) {
        entries.filter(Files::isRegularFile)
               .filter(candidate -> matches(reference, candidate))
               .forEach(match -> Log.user(match.toString()));
    }
}

boolean matches(byte[] reference, Path candidate) {
    try {
        var candidateContent = Files.readAllBytes(candidate);
        return Arrays.equals(reference, candidateContent);
    } catch (IOException e) {
        return false;
    }
}
