#!/usr/bin/env -S java --source 25

/**
 * zmenu - Interactive terminal menu with arrow key navigation
 *
 * Configure menu items via the ITEMS list. Navigate with arrow keys,
 * confirm with Enter, cancel with Escape.
 */

import module java.base;

static void compile(){
    IO.println("compile action");
}

static void test(){
    IO.println("test action");
}

static void build(){
    IO.println("build action");
}

static void noop(){
    IO.println("not implemented");
}

record MenuItem(String label, Runnable action) {}

final List<MenuItem> ITEMS = List.of(
    new MenuItem("Compile project", () -> compile()),
    new MenuItem("Run tests", () -> test()),
    new MenuItem("Package application", () -> build()),
    new MenuItem("Deploy to server", () -> noop()),
    new MenuItem("Clean build artifacts", () -> noop())
);

enum Key {
    UP, DOWN, ENTER, ESCAPE, OTHER;

    static Key read(int[] bytes, int length) {
        if (length == 1) {
            return switch (bytes[0]) {
                case 10, 13 -> ENTER;
                case 27 -> ESCAPE;
                default -> OTHER;
            };
        }
        if (length == 3 && bytes[0] == 27 && bytes[1] == 91) {
            return switch (bytes[2]) {
                case 65 -> UP;
                case 66 -> DOWN;
                default -> OTHER;
            };
        }
        return OTHER;
    }
}

final String CLEAR_LINE = "\033[2K";
final String HIDE_CURSOR = "\033[?25l";
final String SHOW_CURSOR = "\033[?25h";
final String RESET = "\033[0m";
final String BOLD = "\033[1m";
final String DIM = "\033[2m";
final String CYAN = "\033[36m";
final String CURSOR_UP = "\033[%dA";

void main(String... args) throws Exception {
    var result = showMenu("Select an action:", ITEMS);
    result.ifPresentOrElse(
        item -> item.action().run(),
        () -> IO.println("Cancelled")
    );
}

Optional<MenuItem> showMenu(String title, List<MenuItem> items) throws Exception {
    var selectedIndex = 0;
    IO.print(HIDE_CURSOR);
    enableRawMode();
    try {
        IO.println(BOLD + title + RESET);
        renderMenu(items, selectedIndex);
        while (true) {
            switch (readKey()) {
                case UP -> selectedIndex = previousIndex(selectedIndex, items.size());
                case DOWN -> selectedIndex = nextIndex(selectedIndex, items.size());
                case ENTER -> {
                    clearMenu(items.size());
                    return Optional.of(items.get(selectedIndex));
                }
                case ESCAPE -> {
                    clearMenu(items.size());
                    return Optional.empty();
                }
                case OTHER -> {}
            }
            IO.print(CURSOR_UP.formatted(items.size()));
            renderMenu(items, selectedIndex);
        }
    } finally {
        disableRawMode();
        IO.print(SHOW_CURSOR);
    }
}

int previousIndex(int current, int size) {
    return (current - 1 + size) % size;
}

int nextIndex(int current, int size) {
    return (current + 1) % size;
}

void renderMenu(List<MenuItem> items, int selectedIndex) {
    for (int i = 0; i < items.size(); i++) {
        var prefix = (i == selectedIndex) ? " â–¸ " : "   ";
        var style = (i == selectedIndex) ? CYAN + BOLD : DIM;
        IO.println(CLEAR_LINE + style + prefix + items.get(i).label() + RESET);
    }
}

void clearMenu(int lines) {
    IO.print(CURSOR_UP.formatted(lines));
    IO.print((CLEAR_LINE + "\n").repeat(lines));
    IO.print(CURSOR_UP.formatted(lines));
}

void enableRawMode() throws Exception {
    new ProcessBuilder("sh", "-c", "stty -icanon -echo < /dev/tty")
        .inheritIO().start().waitFor();
}

void disableRawMode() throws Exception {
    new ProcessBuilder("sh", "-c", "stty sane < /dev/tty")
        .inheritIO().start().waitFor();
}

Key readKey() throws Exception {
    var bytes = new int[3];
    bytes[0] = System.in.read();
    var length = 1;
    if (bytes[0] == 27 && System.in.available() > 0) {
        bytes[1] = System.in.read();
        length = 2;
        if (System.in.available() > 0) {
            bytes[2] = System.in.read();
            length = 3;
        }
    }
    return Key.read(bytes, length);
}
