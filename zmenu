#!/usr/bin/env -S java --source 25

/**
 * zmenu - Interactive terminal menu with arrow key navigation
 *
 * Configure menu items via the ITEMS list. Navigate with arrow keys,
 * confirm with Enter, cancel with Escape.
 */

import module java.base;

static void compile(){
    IO.println("compile action");
}

static void test(){
    IO.println("test action");
}

static void build(){
    IO.println("build action");
}

static void noop(){
    IO.println("not implemented");
}

record MenuItem(String label, Runnable action) {
    void performAction() {
        action.run();
    }
}

List<MenuItem> menuItems = List.of(
    new MenuItem("Compile project", () -> compile()),
    new MenuItem("Run tests", () -> test()),
    new MenuItem("Package application", () -> build()),
    new MenuItem("Deploy to server", () -> noop()),
    new MenuItem("Clean build artifacts", () -> noop())
);

Runnable cancellationAction = () -> IO.println("Cancelled");

enum Key {
    UP, DOWN, ENTER, ESCAPE, OTHER;

    static final int ESC = '\033';

static Key fromByte(int b) {
        return switch (b) {
            case '\n', '\r' -> ENTER;
            case ESC -> ESCAPE;
            default -> OTHER;
        };
    }

    static Key fromEscapeSequence(int code) {
        return switch (code) {
            case 'A' -> UP;
            case 'B' -> DOWN;
            default -> OTHER;
        };
    }
}

final String CLEAR_LINE = "\033[2K";
final String HIDE_CURSOR = "\033[?25l";
final String SHOW_CURSOR = "\033[?25h";
final String RESET = "\033[0m";
final String BOLD = "\033[1m";
final String DIM = "\033[2m";
final String CYAN = "\033[36m";
final String CURSOR_UP = "\033[%dA";

int selectedIndex = 0;



Optional<MenuItem> showMenu(String title, List<MenuItem> items) throws Exception {
    selectedIndex = 0;
    var itemsSize = items.size();
    IO.print(HIDE_CURSOR);
    enableRawMode();
    try {
        IO.println(BOLD + title + RESET);
        renderMenu(items, selectedIndex);
        while (true) {
            switch (readKey()) {
                case UP -> previousIndex(itemsSize);
                case DOWN -> nextIndex(itemsSize);
                case ENTER -> {
                    clearMenu(itemsSize);
                    return Optional.of(items.get(selectedIndex));
                }
                case ESCAPE -> {
                    clearMenu(itemsSize);
                    return Optional.empty();
                }
                case OTHER -> {}
            }
            IO.print(CURSOR_UP.formatted(itemsSize));
            renderMenu(items, selectedIndex);
        }
    } finally {
        disableRawMode();
        IO.print(SHOW_CURSOR);
    }
}

void previousIndex(int size) {
    selectedIndex = (selectedIndex - 1 + size) % size;
}

void nextIndex(int size) {
    selectedIndex = (selectedIndex + 1) % size;
}

void renderMenu(List<MenuItem> items, int selectedIndex) {
    for (int i = 0; i < items.size(); i++) {
        var prefix = (i == selectedIndex) ? " â–¸ " : "   ";
        var style = (i == selectedIndex) ? CYAN + BOLD : DIM;
        IO.println(CLEAR_LINE + style + prefix + items.get(i).label() + RESET);
    }
}

void clearMenu(int lines) {
    IO.print(CURSOR_UP.formatted(lines));
    IO.print((CLEAR_LINE + "\n").repeat(lines));
    IO.print(CURSOR_UP.formatted(lines));
}

void enableRawMode() throws Exception {
    new ProcessBuilder("sh", "-c", "stty -icanon -echo < /dev/tty")
        .inheritIO().start().waitFor();
}

void disableRawMode() throws Exception {
    new ProcessBuilder("sh", "-c", "stty sane < /dev/tty")
        .inheritIO().start().waitFor();
}

boolean isEscapeSequence(int firstByte) throws Exception {
    return firstByte == Key.ESC && System.in.available() > 0;
}

Key readKey() throws Exception {
    var firstByte = System.in.read();
    if (isEscapeSequence(firstByte)) {
        System.in.read(); // skip '['
        return Key.fromEscapeSequence(System.in.read());
    }
    return Key.fromByte(firstByte);
}

void main() throws Exception {
    showMenu("Select an action:", menuItems)
    .ifPresentOrElse(
        MenuItem::performAction,
        cancellationAction);
}
